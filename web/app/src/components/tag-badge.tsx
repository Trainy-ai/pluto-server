import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import { ExternalLink } from "lucide-react";

export interface ParsedTag {
  type: "linear" | "plain";
  display: string;
  url?: string;
  issueId?: string;
}

/**
 * Parse a tag string to detect integration prefixes.
 * Supported formats:
 * - linear:TRN-123 → Links to Linear issue
 * - plain text → Regular tag
 */
export function parseTag(tag: string): ParsedTag {
  // Linear issue: linear:TRN-123 or linear:ABC-456
  const linearMatch = tag.match(/^linear:([A-Z]+-\d+)$/i);
  if (linearMatch) {
    const issueId = linearMatch[1].toUpperCase();
    return {
      type: "linear",
      display: issueId,
      issueId,
      // Linear's universal issue URL - redirects to correct workspace
      url: `https://linear.app/issue/${issueId}`,
    };
  }

  return {
    type: "plain",
    display: tag,
  };
}

interface TagBadgeProps {
  tag: string;
  className?: string;
  truncate?: boolean;
}

export function TagBadge({ tag, className, truncate }: TagBadgeProps) {
  const parsed = parseTag(tag);

  if (parsed.type === "linear" && parsed.url) {
    return (
      <a
        href={parsed.url}
        target="_blank"
        rel="noopener noreferrer"
        onClick={(e) => e.stopPropagation()}
      >
        <Badge
          variant="secondary"
          className={cn(
            "cursor-pointer gap-1 text-xs",
            "bg-purple-100 text-purple-800 hover:bg-purple-200",
            "dark:bg-purple-900/30 dark:text-purple-300 dark:hover:bg-purple-900/50",
            className
          )}
          title={`Linear issue: ${parsed.issueId}`}
        >
          <LinearIcon className="h-3 w-3 shrink-0" />
          <span>{parsed.display}</span>
          <ExternalLink className="h-2.5 w-2.5 shrink-0 opacity-60" />
        </Badge>
      </a>
    );
  }

  return (
    <Badge
      variant="outline"
      className={cn("shrink-0 text-xs bg-primary/10", truncate && "max-w-[120px] truncate", className)}
    >
      {parsed.display}
    </Badge>
  );
}

/**
 * Simple Linear logo icon
 */
function LinearIcon({ className }: { className?: string }) {
  return (
    <svg
      viewBox="0 0 100 100"
      fill="currentColor"
      className={className}
      aria-label="Linear"
    >
      <path d="M1.22541 61.5228c-.2225-.9485.90748-1.5459 1.59638-.857L39.3342 97.1782c.6889.6889.0915 1.8189-.857 1.5765C20.0515 94.4522 5.54779 79.9485 1.22541 61.5228ZM.00189135 46.8891c-.01764375.2833.08887215.5599.28957765.7606L52.3503 99.7085c.2007.2007.4773.3072.7606.2896 2.3692-.1476 4.6938-.46 6.9624-.9259.7645-.157 1.0301-1.0963.4782-1.6481L4.57308 41.4454c-.55188-.5519-1.49117-.2863-1.64812.4782-.46595 2.2686-.77832 4.5932-.92307 6.9655ZM4.53755 32.1837c-.27673-.6857.17399-1.4381.90876-1.4947 4.64089-.3577 9.15576-.2655 13.49849.2227.76828.0864 1.01948.9983.45361 1.5642L5.57551 46.2987c-.56587.5658-1.47777.3147-1.5642-.4536-.48822-4.3427-.58046-8.8576-.47346-13.6614ZM9.5989 23.8752c-.15643-.6525.32633-1.2821.99363-1.3142 5.08822-.2446 9.99842-.0585 14.70332.5252.74573.0926.99542.9738.45099 1.5183l-13.0546 13.0545c-.54432.5444-1.42566.2948-1.51822-.4509-.5765-4.6564-.79345-9.5123-.57512-14.3329ZM15.6281 16.0313c-.0853-.6275.43909-1.1604 1.06965-1.1117 4.83498.3735 9.53175 1.1381 14.02815 2.2608.6927.1729.9109 1.0197.394 1.5366L18.758 31.0787c-.5169.517-1.36375.2987-1.53661-.3941-1.11772-4.4806-1.88178-9.1588-2.59329-14.6533ZM22.5684 9.60113c-.0131-.6395.52023-1.1356 1.15973-1.06151 4.31114.49885 8.52328 1.34058 12.59958 2.48833.66298.18671.8653 1.00953.36584 1.50919l-12.0653 12.0653c-.49966.4994-1.32248.2972-1.50919-.366-1.13954-4.0546-1.99222-8.2455-2.55066-14.63531ZM30.9722 4.7305c.0619-.62369.58137-1.10572 1.20715-1.01728 3.95727.55932 7.83334 1.42229 11.59764 2.5637.61834.18757.80063.93724.32939 1.40848L32.3676 19.4245c-.4713.4713-1.22091.2889-1.40848-.3294-1.08931-3.5927-1.95852-7.31499-2.58534-11.22721-.10554-.65895.12003-1.22699.59862-3.13689ZM40.8529 1.85669c.1065-.60322.6732-1.00056 1.2814-.89464 3.4079.59385 6.7408 1.44993 9.9716 2.5489.5765.19595.7479.89329.3104 1.33079L41.9458 15.3117c-.4375.4375-1.13484.2661-1.33079-.3104-1.04672-3.0811-1.91664-6.25771-2.65616-9.59781-.15496-.70056-.01745-1.13977.89405-3.54661ZM51.9498.311971c.1644-.534224.75125-.816498 1.27467-.628782 2.90756.10424 5.75689 1.389472 8.51866 2.431831.4987.188239.6483.806386.2711 1.18358L52.5765 12.7362c-.3773.3773-.9952.2277-1.1836-.2711-.9846-2.6066-1.8069-5.27719-2.47-8.009499-.14746-.60755-.0376-1.11498 1.0269-4.138131ZM63.3344 3.3936c.2208-.47804.7927-.6744 1.2574-.43091 2.3149 1.21308 4.5559 2.55566 6.7087 4.01595.38.25767.4455.78089.1494 1.12007L62.4457 17.103c-.2961.33918-.822.2821-1.0365-.1128-.4324-.79636-1.4509-2.28624-2.1518-3.31363-1.8866-2.76462-3.4181-4.72723 4.0686-10.28297l.0084.00004ZM74.7839 11.9168c.2936-.39498.8445-.47548 1.2128-.16671 1.8665 1.56537 3.6396 3.24693 5.3054 5.03913.2866.30844.2511.79274-.0796 1.05553L71.0339 25.2965c-.3308.2628-.8128.1816-1.0422-.1751-.394-.61328-1.5625-2.23614-2.2168-3.0991-1.69015-2.22957-3.0762-4.08965 6.9928-10.10567l.0162.00017ZM84.4992 22.4421c.3378-.31283.8686-.2968 1.1873.0361 1.4639 1.52906 2.841 3.14215 4.1236 4.83257.2259.29768.1737.72398-.1163.97296l-8.6758 7.4479c-.29.2489-.7278.1832-.9449-.142-.4005-.5996-1.3754-1.98205-1.987-2.76906-1.62895-2.09627-2.93925-4.10733 6.4131-10.37837ZM92.3426 34.8094c.3648-.26455.8743-.17652 1.1371.1965 1.1382 1.6167 2.1893 3.29704 3.1475 5.03387.1658.30047.0629.68076-.23 .87204l-8.8231 5.76629c-.2929.19128-.6868.07675-.8514-.24848-1.1528-2.27686-1.7617-3.36133-2.7481-4.74066 1.3025-1.11395 5.5554-4.88498 8.3677-6.87956l.0003.00004ZM97.4772 48.6514c.3885-.1693.8431-.00444 1.0108.3847.7309 1.6964 1.3765 3.4359 1.9325 5.21371.0982.31409-.0533.65315-.3485.78083l-7.2015 3.11488c-.2952.12768-.6437-.02505-.753-.33073-.8332-2.32869-1.5152-3.76382-2.4455-5.61326.8466-.48746 5.4827-2.36498 7.8052-3.55013Z" />
    </svg>
  );
}
