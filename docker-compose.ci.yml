version: '3'

services:
  db:
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "postgres", "-d", "postgres" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  minio:
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  clickhouse:
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  ingest:
    image: mlop-ingest:latest
    build: null
    depends_on:
      db:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s

  backend:
    image: mlop-backend:latest
    build: null
    depends_on:
      db:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      minio:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c", "corepack enable pnpm && cd /app && pnpm exec prisma migrate deploy && cd /app/.next/standalone && node server.js"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  frontend:
    image: mlop-frontend:latest
    build: null
    depends_on:
      backend:
        condition: service_healthy

  py:
    image: mlop-py:latest
    build: null
    depends_on:
      db:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/healthz"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s

  minio_create:
    restart: "no"
